<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel='import' href='../bower_components/paper-progress/paper-progress.html'>
<link rel='import' href='./comment-section.html'>
<link rel="import" href="shared-styles.html">

<!-- Alert Page Tabs -->
<link rel='import' href='./alert-page/activitylog-tab.html'>
<link rel='import' href='./alert-page/resume-tab.html'>
<link rel='import' href='./alert-page/task-tab.html'>

<dom-module id="alert-page">
    <template>
        <style include='shared-styles'>
            :host {
                display: block
            }
            
            .header div {
                width: 120px;
                text-align: center;
                padding: 5px 15px;
                
            }
            .header div:hover{
                cursor: pointer;
            }
            iron-selector   .iron-selected{
                border-top: 1px solid black;
                border-left: 1px solid black;
                border-right: 1px solid black;
            }
            .container {
                position: relative;
            }
            
            .content {
                width: 100%;
            }
        </style>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>
        
        <div class="flex flex--col container">
            <iron-selector selected="{{selTab}}" attr-for-selected="name" fallback-selection="resume-tab" role="navigation" class="flex flex--row flex__item header">
                <div class="flex__item--top flex__item" name="resume-tab">Détails</div>
                <div class="flex__item--top flex__item" name="activitylog-tab">Fil d'activité</div>
                <template is="dom-if" if={{_taskVisible(storedUser.id_Groupe)}}>
                    <div class="flex__item--top flex__item" name="task-tab">Tâches</div>
                </template>
            </iron-selector>
            <iron-pages selected="{{selTab}}" attr-for-selected="name" role="main" class="flex__item flex__item--top content">
                <resume-tab name='resume-tab' project-data={{projectData}} stored-user={{storedUser}} id='rstab'></resume-tab>
                <activitylog-tab name='activitylog-tab' project-data={{projectData}} log-data={{logData}}></activitylog-tab>
                <task-tab name='task-tab' project-data={{projectData}}></task-tab>
            </iron-pages>
            
            <iron-ajax headers='{"access-control-allow-origin": "*", Accept: "*/*"}' id="ajaxEl" content-type="application/json" on-response="handleResponse"></iron-ajax>
        </div>
    </template>
    <script>
        class alertPage extends Polymer.Element {
            
            static get is() {
                return 'alert-page';
            }
            static get properties() {
                return {
                    projectId: {
                        observer: '_projectIdChanged'
                    },
                    projectData: Object,
                    commentThread: String,
                    trigger: {
                        observer: '_aptrChanged'
                    }
                };
            }
            ready() {
                super.ready();
                this.$.rstab.addEventListener('askprojectdata', function () {
                    this._getProjectData(this.projectId);
                }.bind(this));
            }
            _aptrChanged(){
                this._getProjectData(this.projectId);
            }
            _taskVisible(id_group){
                return (id_group == '6' || id_group == '7') ? true : false;
            }
            _projectIdChanged(val){
                // this._getProjectData(val);
            }
            _getProjectData(projectId) {
                // console.log('Getting Projet Data...');
                
                var url = '/missions/' + projectId;
                this.$.ajaxEl.url = url;
                this.$.ajaxEl.method = "GET";
                this.$.ajaxEl.generateRequest();
            }
            handleResponse(evt) {
                // console.log(evt.detail.response);
                this.set('projectData', evt.detail.response[0][0]);
                this.set('projectData.espece', evt.detail.response[1][0].espece);
                this.set('logData', evt.detail.response[0][0].activity_log);
                this.dispatchEvent(new CustomEvent('projectData', {detail : {projectData : this.projectData}}));
                console.log('Project Data ', this.projectData);
                
            }
        }
        window.customElements.define(alertPage.is, alertPage);
    </script>
</dom-module>