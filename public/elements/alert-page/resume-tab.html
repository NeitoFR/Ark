<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../shared-styles.html'>
<dom-module id='resume-tab'>
    <template>
        <style include='shared-styles'>
            .alert {
                width: 80%;
                background-color: white;
                padding: 24px;
                border-right: solid 1px rgb(185, 185, 185);
                
            }
            
            .menu {
                width: 20%;
                background-color: white;
            }
            
            .alert,
            .menu {
                box-sizing: border-box;
            }
            
            paper-progress {
                --paper-progress-height: 25px;
            }
            
            #progecoute {
                --paper-progress-active-color: rgb(209, 212, 17);
            }
            
            #progexpert {
                --paper-progress-active-color: blue;
            }
            
            #progcomite {
                --paper-progress-active-color: red;
            }
            
            #progval {
                --paper-progress-active-color: var(--apc);
            }
            
            #proginval {
                --paper-progress-active-color: red;
            }
            
            #proginfo {
                --paper-progress-active-color: rgb(209, 212, 17);
            }
            
            .sd-div {
                text-align: center;
                padding: 3px 0px;
            }
            
            .steps,
            .step-details,
            .actions,
            .participate {
                border-bottom: solid 1px rgb(185, 185, 185);
                
            }
            
            .participate {
                text-align: center;
                padding: 15px;
            }
            
            .steps {
                padding: 10px 24px 40px;
            }
            
            .step-details {
                padding: 20px 24px 20px;
                
            }
            
            .actions {
                padding: 40px 24px 10px;
            }
            
            .article {
                padding: 7px 0px;
            }
        </style>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>
        
        <div class="flex flex--row">
            <div class="flex flex--col flex__item--top alert">
                <div class="flex flex--row flex__item article">
                    <div class="flex__item--top flex__item">{{projectData.nom}}</div>
                    <div class="flex__item--top flex__item">Espece concernée : {{projectData.espece}}</div>
                    <div class="flex__item--top">{{projectData.date_creation}}</div>
                </div>
                <div class="flex flex--row flex__item article">
                    <div class="flex__item">Contient : {{projectData.continent}}</div>
                    <div class="flex__item">Pays : {{projectData.pays}}</div>
                    <div class="flex__item--bottom" style="text-align: right">Ville : {{projectData.ville}}</div>
                </div>
                <div class="flex__item--top article">
                    <p>Résumé : {{projectData.resume}}</p>
                </div>
                <div class="flex__item article">
                    {{projectData.contenu}}
                </div>
                <div class="flex__item article">
                    <comment-section id="commentSection" comment-thread={{commentThread}}></comment-section>
                </div>
            </div>
            <div class="flex flex--col flex__item--top menu">
                <div class="flex__item  steps">
                    <p>Résumé Etape</p>
                    Equipe d'écoute 5/5
                    <paper-progress value="5" max="5" min="0" id="progecoute"></paper-progress>
                    Equipe d'expert 2/5
                    <paper-progress value="2" max="5" min="0" id="progexpert"></paper-progress>
                    Equipe comité 0/1
                    <paper-progress value="0" max="1" min="0" id="progcomite"></paper-progress>
                </div>
                
                <template is="dom-if" if={{_actionVisible(projectData.initiateur)}}>
                    <div class="flex__item actions">
                        <div class="flex flex--col">
                            <div class="flex__item--middle sd-div">Actions possibles</div>
                            <div class="flex__item"></div>
                            <div class="flex__item flex flex--row">
                                <div class="flex__item sd-div">
                                    <paper-button raised on-tap="_testButton" class="primary">Valider</paper-button>
                                </div>
                                <div class="flex__item sd-div">
                                    <paper-button raised on-tap="_testButton" class="primary">Invalider</paper-button>
                                </div>
                            </div>
                            <div class="flex__item  sd-div">
                                <paper-button raised on-tap="_testButton" class="primary">Demande Info</paper-button>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div class="flex__item step-details">
                    <p>Détails Etape actuel </p>
                    Validation
                    <paper-progress value="4" max="5" min="0" id="progval"></paper-progress>
                    Invalidation
                    <paper-progress value="1" max="5" min="0" id="proginval"></paper-progress>
                    Demande d'info
                    <paper-progress value="1" max="3" min="0" id="proginfo"></paper-progress>
                </div>
                <div class="flex__item participate">
                    <paper-button raised on-tap="_submitParticip" class="primary" disabled={{partBut}}>Participer</paper-button>
                </div>
            </div>
        </div>
        <iron-ajax id="ajaxEl" content-type="application/json" on-response="handleResponse"></iron-ajax>
        
    </template>
    <script>
        class ResumeTab extends Polymer.Element {
            static get is() {
                return 'resume-tab'
            }
            static get properties() {
                return {
                    projectData: {
                        type: Object,
                        observer: '_projectDataChanged'
                    },
                    commentThread: {
                        type: String
                    },
                    partBut: {
                        type : Boolean,
                        value : false
                    }
                }
            }
            ready() {
                super.ready();
                
                this.$.commentSection.addEventListener('newcomment', function () {
                    this._getNewComment(this.projectData.id_Mission);
                }.bind(this));
            }
            _actionVisible(val){
                return this.storedUser.id_Utilisateurs == this.projectData.initiateur ? true : false;
            }
            _getNewComment(projectId) {
                var url = '/comment/' + projectId;
                this.$.ajaxEl.url = url;
                this.$.ajaxEl.method = "GET";
                this.$.ajaxEl.generateRequest();
            }
            handleResponse(evt) {
                if(evt.detail.url == '/maria/submit-participation'){
                    this.dispatchEvent(new CustomEvent('askprojectdata'));
                }
                if(evt.detail.url.includes("comment")){
                    console.log('comment ', evt.detail.response);
                    this.set('commentThread', evt.detail.response[0].commentaires)
                }
            }         
            _checkParticipant(stringP, stringV) {
                if(this.projectData){
                    if(stringP){
                        var rawP = stringP.split('|');
                        rawP.splice(0, 1);
                        for(var i = 0; i < rawP.length; i++){
                            var temp = rawP[i].split(';');
                            if(temp[0] == this.storedUser.id_Utilisateurs)
                            {
                                this.set('partBut', true);
                                break;
                            }
                        }
                    }
                    if(this.partBut == true) return;
                    if(stringV){
                        var rawV = stringV.split('|');
                        rawV.splice(0, 1);
                        for(var i = 0; i < rawV.length; i++){
                            var temp = rawV[i].split(';');
                            if(temp[0] == this.storedUser.id_Utilisateurs)
                            {
                                this.partBut = true;
                                break;
                            }
                        }
                    }
                }
            }
            _projectDataChanged(projectData) {
                this.set('projectData', projectData);
                this.set('commentThread', projectData.commentaires);
                this._checkParticipant(this.projectData.m_potentiel, this.projectData.m_valider);
            }
            _submitParticip(){
                var url = '/maria/submit-participation';
                this.$.ajaxEl.url = url;
                this.$.ajaxEl.body = {
                    pseudo : this.storedUser.pseudo,
                    id_Utilisateurs : this.storedUser.id_Utilisateurs,
                    id_Status : this.projectData.id_Status,
                    id_Mission : this.projectData.id_Mission,
                    string : '|'+this.storedUser.id_Utilisateurs+';'+this.storedUser.pseudo
                };
                this.$.ajaxEl.method = "POST";
                this.$.ajaxEl.generateRequest();
            }
        }
        window.customElements.define(ResumeTab.is, ResumeTab);
    </script>
</dom-module>