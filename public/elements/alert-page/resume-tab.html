<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../shared-styles.html'>
<dom-module id='resume-tab'>
    <template>
        <style include='shared-styles'>
            .alert {
                width: 80%;
                background-color: white;
                padding: 24px;
                border-right: solid 1px rgb(185, 185, 185);

            }

            .menu {
                width: 20%;
                background-color: white;
            }

            .alert,
            .menu {
                box-sizing: border-box;
            }

            paper-progress {
                --paper-progress-height: 25px;
            }

            #progecoute {
                --paper-progress-active-color: rgb(209, 212, 17);
            }

            #progexpert {
                --paper-progress-active-color: blue;
            }

            #progcomite {
                --paper-progress-active-color: red;
            }

            #progval {
                --paper-progress-active-color: var(--apc);
            }

            #proginval {
                --paper-progress-active-color: red;
            }

            #proginfo {
                --paper-progress-active-color: rgb(209, 212, 17);
            }

            .sd-div {
                text-align: center;
                padding: 3px 0px;
            }

            .steps,
            .step-details,
            .actions,
            .participate {
                border-bottom: solid 1px rgb(185, 185, 185);

            }

            .participate {
                text-align: center;
                padding: 15px;
            }

            .steps {
                padding: 10px 24px 40px;
            }

            .step-details {
                padding: 20px 24px 20px;

            }

            .actions {
                padding: 40px 24px 10px;
            }

            .article {
                padding: 7px 0px;
            }

            paper-checkbox {
                --paper-checkbox-vertical-align: top;
                padding: 5px;
            }

            paper-checkbox.red {
                border: 1px solid var(--paper-red-400);
                /* background-color: var(--paper-red-200); */
                padding: 8px 16px;
                /* --paper-checkbox-size: 2em; */
                --paper-checkbox-checked-color: var(--paper-red-500);
                --paper-checkbox-checked-ink-color: var(--paper-red-500);
                --paper-checkbox-unchecked-color: var(--paper-red-900);
                --paper-checkbox-unchecked-ink-color: var(--paper-red-900);
                --paper-checkbox-label-color: var(--paper-red-700);
            }

            paper-checkbox.green {
                /* --paper-checkbox-size: 2em; */
                border: 1px solid var(--paper-green-400);
                padding: 8px 16px;
                /* background-color: var(--paper-green-200); */
                --paper-checkbox-checked-color: var(--paper-green-500);
                --paper-checkbox-checked-ink-color: var(--paper-green-500);
                --paper-checkbox-unchecked-color: var(--paper-green-900);
                --paper-checkbox-unchecked-ink-color: var(--paper-green-900);
                --paper-checkbox-label-color: var(--paper-green-700);
            }

            paper-checkbox .title {
                display: block;
                font-size: 1.2em;
            }

            paper-checkbox .subtitle {
                display: block;
                font-size: 0.9em;
                max-width: 150px;
            }
        </style>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

        <div class="flex flex--row">
            <div class="flex flex--col flex__item--top alert">
                <div class="flex flex--row flex__item article">
                    <div class="flex__item--top flex__item">{{projectData.nom}}</div>
                    <div class="flex__item--top flex__item">Espece concernée : {{projectData.espece}}</div>
                    <div class="flex__item--top">{{projectData.date_creation}}</div>
                </div>
                <div class="flex flex--row flex__item article">
                    <div class="flex__item">Contient : {{projectData.continent}}</div>
                    <div class="flex__item">Pays : {{projectData.pays}}</div>
                    <div class="flex__item--bottom" style="text-align: right">Ville : {{projectData.ville}}</div>
                </div>
                <div class="flex__item--top article">
                    <p>Résumé : {{projectData.resume}}</p>
                </div>
                <div class="flex__item article">
                    {{projectData.contenu}}
                </div>
                <div class="flex__item article">
                    <comment-section id="commentSection" comment-thread={{commentThread}}></comment-section>
                </div>
            </div>

            <!-- Side Menu -->
            <div class="flex flex--col flex__item--top menu">
                <div class="flex__item  steps">
                    <p>Résumé Etape</p>
                    <iron-pages selected="{{selSteps}}" attr-for-selected="name" fallback-selection="mainSteps" role="main">
                        <div name='mainSteps'>
                            <paper-checkbox class="test test2" id='check1' checked={{isChecked1}} disabled>
                                <span class="title">Etape 1</span>
                                <span class="subtitle">Valider par l'équipe d'écoute</span>
                            </paper-checkbox>
                            <paper-checkbox class="" id="check2" checked={{isChecked2}} disabled>
                                <span class="title">Etape 2</span>
                                <span class="subtitle">Valider par l'équipe d'expert</span>
                            </paper-checkbox>
                            <paper-checkbox class="" id="check3" checked={{isChecked3}} disabled>
                                <span class="title">Etape 3</span>
                                <span class="subtitle">Valider par le Comité d'évaluation</span>
                            </paper-checkbox>
                        </div>
                        <div name='Steps0'>
                            En attente d'info de la part de l'auteur...
                        </div>
                    </iron-pages>
                </div>

                <template is="dom-if" if={{_actionVisible(projectData.initiateur)}}>
                    <div class="flex__item actions">
                        <div class="flex flex--col">
                            <div class="flex__item--middle sd-div">Actions possibles</div>
                            <div class="flex__item"></div>
                            <div class="flex__item flex flex--row">
                                <div class="flex__item sd-div">
                                    <paper-button raised on-tap="_sendVal" class="primary" disabled={{val_but}}>Valider</paper-button>
                                    <!-- <paper-button raised on-tap="{{_sendAvis(1)}}" class="primary" disabled={{val_but}}>Valider</paper-button> -->
                                </div>
                                <div class="flex__item sd-div">
                                    <paper-button raised on-tap="_sendInval" class="primary" disabled={{inval_but}}>Invalider</paper-button>
                                    <!-- <paper-button raised on-tap="{{_sendAvis(2)}}" class="primary" disabled={{inval_but}}>Invalider</paper-button> -->
                                </div>
                            </div>
                            <div class="flex__item  sd-div">
                                <paper-button raised on-tap="_sendInfo" class="primary" disabled={{info_but}}>Demande Info</paper-button>
                                <!-- <paper-button raised on-tap="{{_sendAvis(3)}}" class="primary" disabled={{info_but}}>Demande Info</paper-button> -->
                            </div>
                        </div>
                    </div>
                </template>

                <div class="flex__item step-details">
                    <p>Détails Etape actuel </p>
                    Validation
                    <paper-progress value="{{valval}}" max="5" min="0" id="progval"></paper-progress>
                    Invalidation
                    <paper-progress value="{{valinval}}" max="5" min="0" id="proginval"></paper-progress>
                    Demande d'info
                    <paper-progress value="{{valinfo}}" max="3" min="0" id="proginfo"></paper-progress>
                </div>
                <div class="flex__item participate">
                    <paper-button raised on-tap="_submitParticip" class="primary" disabled={{partBut}}>Participer</paper-button>
                </div>
            </div>
        </div>
        <iron-ajax headers='{"access-control-allow-origin": "*", Accept: "*/*"}' id="ajaxEl" content-type="application/json" on-response="handleResponse"></iron-ajax>

    </template>
    <script>
        class ResumeTab extends Polymer.Element {
            static get is() {
                return 'resume-tab'
            }
            static get properties() {
                return {
                    projectData: {
                        type: Object,
                        observer: '_projectDataChanged'
                    },
                    commentThread: {
                        type: String
                    },
                    partBut: {
                        type: Boolean,
                        value: false
                    },
                    isChecked1: Boolean,
                    isChecked2: Boolean,
                    isChecked3: Boolean,
                    val_but: Boolean,
                    inval_but: Boolean,
                    info_but: Boolean,
                    toVal: {
                        type: Number,
                        value: 1
                    },
                    toInval: {
                        type: Number,
                        value: 2
                    },
                    toInfo: {
                        type: Number,
                        value: 3
                    },
                    storedUser: {
                        observer: '_storedUserChanged'
                    }
                }
            }
            ready() {
                super.ready();

                this.$.commentSection.addEventListener('newcomment', function () {
                    this._getNewComment(this.projectData.id_Mission);
                }.bind(this));
            }
            _testButton() {
                this.$.check1.classList.add('green');
            }
            // _storedUserChanged(){
            //     this.dispatchEvent(new CustomEvent('askprojectdata'));
            // }
            _sendVal() {
                this._sendAvis(1);
            }
            _sendInval() {
                this._sendAvis(2);
            }
            _sendInfo() {
                this._sendAvis(3);
            }
            _sendAvis(avis) {
                console.log();

                this.$.ajaxEl.url = '/maria/submit-avis'
                this.$.ajaxEl.method = 'POST'
                this.$.ajaxEl.body = {
                    'id_Utilisateurs': this.storedUser.id_Utilisateurs,
                    'id_Groupe': this.storedUser.id_Groupe,
                    'id_Mission': this.projectData.id_Mission,
                    'avis': avis
                };
                this.$.ajaxEl.generateRequest();
            }
            _actionVisible(val) {
                // return true;
                return this.storedUser.id_Utilisateurs == this.projectData.initiateur ? false : true;
            }
            _getNewComment(projectId) {
                var url = '/comment/' + projectId;
                this.$.ajaxEl.url = url;
                this.$.ajaxEl.method = "GET";
                this.$.ajaxEl.generateRequest();
            }
            handleResponse(evt) {
                if (evt.detail.url == '/maria/submit-participation') {
                    this.dispatchEvent(new CustomEvent('askprojectdata'));
                }
                if (evt.detail.url.includes("comment")) {
                    console.log('comment ', evt.detail.response);
                    this.set('commentThread', evt.detail.response[0].commentaires)
                }
                if (evt.detail.url = '/maria/submit-avis') {
                    console.log(evt.detail.response);
                    this.dispatchEvent(new CustomEvent('askprojectdata'));
                }
            }
            _checkParticipant(stringP, stringV) {
                if (this.projectData) {
                    console.log('Checking participant...');

                    var particpe = false;
                    if (stringP) {
                        var rawP = stringP.split('|');
                        rawP.splice(0, 1);
                        for (var i = 0; i < rawP.length; i++) {
                            var temp = rawP[i].split(';');
                            console.log(temp[0] + ':' + this.storedUser.id_Utilisateurs);

                            if (temp[0] == this.storedUser.id_Utilisateurs) {
                                console.log('Participe déjà');

                                particpe = true;
                                this.set('partBut', true);
                                break;
                            }
                        }
                    }
                    // if (this.partBut == true) return;
                    if (stringV) {
                        var rawV = stringV.split('|');
                        rawV.splice(0, 1);
                        for (var i = 0; i < rawV.length; i++) {
                            var temp = rawV[i].split(';');
                            console.log(temp[0] + ':' + this.storedUser.id_Utilisateurs);
                            if (temp[0] == this.storedUser.id_Utilisateurs) {
                                particpe = true;
                                this.set('partBut', true);
                                break;
                            }
                        }
                    }
                    if (particpe == false) {
                        this.set('partBut', false);
                        console.log('Vous pouvez participé');
                    }
                    // particpe == false ? this.set('partBut', false) : console.log('Vous participé déjà');

                }
            }
            _projectDataChanged(projectData) {
                this.set('projectData', projectData);
                this.set('commentThread', projectData.commentaires);
                this._setViewForIdStatus(projectData.id_Status);
                this._checkParticipant(this.projectData.m_potentiel, this.projectData.m_valider);
                this._setProgressBarValues(this.projectData.v_cur_step);
                this._setActionButtonState(this.storedUser.id_Groupe, projectData.id_Status);
                if (projectData.id_Status == 0) this.set('SelSteps', 'mainSteps');
            }
            _checkValideur(valString) {
                var acteurs = [];
                valString = valString.split('|');

                valString.forEach(groupe => {
                    if (groupe.includes(';')) {
                        var temp = groupe.split(';');
                        temp.splice(0, 1);
                        temp.forEach(user => {
                            acteurs.push(user);
                        });
                    }
                });
                // console.log(acteurs);
                for (var i = 0; i < acteurs.length; i++) {
                    if (acteurs[i] == this.storedUser.id_Utilisateurs) {
                        console.log('Vous avez déjà voté');
                        return true;
                    }
                }
                return false;
            }
            _setActionButtonState(user_group, mission_status) {
                // console.log('user_group : '+user_group+' mission_status : '+mission_status);
                if (this._checkValideur(this.projectData.v_cur_step)) {
                    console.log('Deactivating buttons');

                    this.set('val_but', true);
                    this.set('inval_but', true);
                    this.set('info_but', true);
                    return;
                }
                if (mission_status == 1 && user_group == 5) {
                    // console.log('Activating Buttons');

                    this.set('val_but', false);
                    this.set('inval_but', false);
                    this.set('info_but', false);
                } else if (mission_status == 2 && user_group == 6) {
                    // console.log('Activating Buttons');

                    this.set('val_but', false);
                    this.set('inval_but', false);
                    this.set('info_but', false);
                } else if (mission_status == 3 && user_group == 7) {
                    // console.log('Activating Buttons');

                    this.set('val_but', false);
                    this.set('inval_but', false);
                    this.set('info_but', false);
                } else {
                    // console.log('Deactivating Buttons');

                    this.set('val_but', true);
                    this.set('inval_but', true);
                    this.set('info_but', true);
                }
            }
            _setProgressBarValues(iString) {
                // console.log(iString);
                console.log('Checeking progress bar values...', iString);

                var groups = iString.split('|');
                for (var i = 0; i < groups.length; i++) {
                    groups[i] = groups[i].split(';');
                    groups[i].splice(0, 1);
                    console.log('group ' + i, groups[i]);

                }
                // console.log('grouped user', groups);
                if (groups[0][0] == '') this.set('valval', 0);
                else this.set('valval', groups[0].length);
                if (groups[1][0] == '') this.set('valinval', 0);
                else this.set('valinval', groups[1].length);
                if (groups[2][0] == '') this.set('valinfo', 0);
                else this.set('valinfo', groups[2].length);
            }
            _setViewForIdStatus(id) {
                // console.log('id status', id);
                if (id == 0) {
                    console.log('Etape 0!! ');

                    this.set('selSteps', 'Steps0');
                } else {
                    this.set('selSteps', 'mainSteps');
                }
                if (id >= 2) {
                    this.set('isChecked1', true); //En cours expert = valider ecoute
                    this.$.check1.classList.add('green');
                } else {
                    this.$.check1.classList.remove('green');
                    this.set('isChecked1', false);
                }
                if (id >= 3) {
                    this.set('isChecked2', true); //En courd comité = valider expert
                    this.$.check2.classList.add('green');
                } else {
                    this.$.check2.classList.remove('green');
                    this.set('isChecked2', false);
                }
                if (id == 4) {
                    this.set('isChecked3', true); // Est un projet validé
                    this.$.check3.classList.add('green');
                } else {
                    this.$.check3.classList.remove('green');
                    this.set('isChecked3', false);
                }
            }
            _submitParticip() {
                var url = '/maria/submit-participation';
                this.$.ajaxEl.url = url;
                this.$.ajaxEl.body = {
                    pseudo: this.storedUser.pseudo,
                    id_Utilisateurs: this.storedUser.id_Utilisateurs,
                    id_Status: this.projectData.id_Status,
                    id_Mission: this.projectData.id_Mission,
                    string: '|' + this.storedUser.id_Utilisateurs + ';' + this.storedUser.pseudo
                };
                this.$.ajaxEl.method = "POST";
                this.$.ajaxEl.generateRequest();
            }
        }
        window.customElements.define(ResumeTab.is, ResumeTab);
    </script>
</dom-module>